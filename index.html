<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>KettyBot Platformer â€” Mario Style + Enemies</title>
  <style>
    :root{
      --sky1:#6ec6ff; --sky2:#b7e5ff;
      --soil:#000000; --soil2:#252222;
      --grass:#2b2b2b; --grass2:#767876;
      --brick:#b05a26; --brick2:#e07a2f;
      --pipe:#179940; --pipeDark:#0e6a2c;
      --coin:#ffd84d; --flag:#ec1d2f;
      --ink:#0f172a; --btn:#ffb703; --btn2:#2a9d8f;
      --enemy:#b44a32; --enemyDark:#7d2e1f;
       --asphalt:  #2f3338;   /* Ù„ÙˆÙ† Ø§Ù„Ø£Ø³ÙÙ„Øª */

  /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø³Ù…Ø§Ø¡ Ø§Ù„ØªÙŠ Ø¹Ù†Ø¯Ùƒ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ */
  --shopWall:#ffe6c7;   /* Ù„ÙˆÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ù„ */
  --shopRoof:#e5673e;   /* Ø§Ù„Ø³Ù‚Ù/Ø§Ù„ÙƒØ±Ø§Ù†ÙŠØ´ */
  --shopDoor:#1f2937;   /* Ø§Ù„Ø¨Ø§Ø¨ */
  --shopGlass:#ffffffb0;/* Ø²Ø¬Ø§Ø¬ ÙˆØ§Ø¬Ù‡Ø© Ø´ÙØ§Ù */
  --awning1:#ff7a7a;    /* Ø§Ù„Ù…Ø¸Ù„Ù‘Ø© (Ø®Ø· Ø£Ø­Ù…Ø± Ø¨Ø§Ù‡Øª) */
  --awning2:#ffe3e3;    /* Ø§Ù„Ù…Ø¸Ù„Ù‘Ø© (Ø®Ø· ÙØ§ØªØ­) */
  --accent:#ffd166;     /* Ø´Ø±ÙŠØ· Ø¥Ø¶Ø§Ø¡Ø© Ø¨Ø³ÙŠØ· Ø¨Ù„Ø§ ÙƒØªØ§Ø¨Ø© */
  --tree:#3aa35b; --treeDark:#2d7d43; /* Ø£Ø´Ø¬Ø§Ø± Ø§Ù„Ø´Ø§Ø±Ø¹ */
  --pavement:#d9d9d9;   /* Ù„ÙˆÙ† Ø§Ù„Ø±ØµÙŠÙ */
  --pavementDark:#bfbfbf; /* Ø¸Ù„/ØªÙØµÙŠÙ„ */
--kid-shirt:#4f46e5;   /* Ù‚Ù…ÙŠØµ Ø£Ø²Ø±Ù‚ */
  --kid-pants:#374151;   /* Ø¨Ù†Ø·Ø§Ù„ Ø¯Ø§ÙƒÙ† */
  --kid-skin:#f6c39b;    /* Ø¨Ø´Ø±Ø© */
  --kid-hair:#2b2b2b;    /* Ø´Ø¹Ø± */
  --kid-shoes:#111827;   /* Ø­Ø°Ø§Ø¡ */


    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Arial}
    body{display:grid;place-items:center;background:linear-gradient(var(--sky1),var(--sky2));color:var(--ink)}
    .wrap{width:min(100vw,920px);padding:12px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .hud{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tag{background:#ffffffaa;border:1px solid #00000010;color:#111;padding:.35rem .65rem;border-radius:.6rem;font-variant-numeric:tabular-nums}
    .btn{background:var(--btn);color:#111;border:none;padding:.55rem 1rem;border-radius:.8rem;cursor:pointer;font-weight:700}
    .btn.secondary{background:var(--btn2);color:#fff}
    canvas{width:100%;height:auto;background:linear-gradient(#87ceeb,#a0d9ff);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);border:1px solid #4aa3d9}
/* === ØªØ­ÙƒÙ‘Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¹Ù…Ù„ÙŠ === */
.touch {
  position: fixed;
  inset: auto 0 8px 0;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  padding: 12px;
  z-index: 90;
  user-select: none;
  -webkit-user-select: none;
  touch-action: none; /* Ù…Ù†Ø¹ Ø³Ø­Ø¨/Ø²ÙˆÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠ */
}

.touch .panel {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  background: rgba(255,255,255,.18);
  backdrop-filter: blur(8px);
  border: 1px solid #ffffff30;
  border-radius: 14px;
  padding: 10px;
}

.tbtn {
  width: 84px; height: 84px;
  border-radius: 16px;
  border: 1px solid #00000022;
  background: #ffffffd9;
  font: 700 20px system-ui;
  display: grid;
  place-items: center;
  box-shadow: 0 6px 16px rgba(0,0,0,.15);
}

.tbtn.circle { border-radius: 50%; }
.tbtn.big    { width: 120px; height: 120px; font-size: 22px; }
.tbtn.on     { transform: translateY(2px); opacity: .9; }

@media (min-width: 721px){ .touch{ display:none } } /* ÙƒÙ…Ø¨ÙŠÙˆØªØ± */

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="hud">
        <span class="tag">ğŸŸ¡ Ø¹Ù…Ù„Ø§Øª: <b id="coin-count">0</b>/<b id="coin-total">0</b></span>
        <span class="tag">â±ï¸ ÙˆÙ‚Øª: <b id="time">0.0</b>s</span>
        <span class="tag">â¤ï¸ Ù…Ø­Ø§ÙˆÙ„Ø§Øª: <b id="lives">3</b></span>
      </div>
      <div>
        <button id="start" class="btn">Ø§Ø¨Ø¯Ø£</button>
        <button id="reset" class="btn secondary">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>
    </header>

    <canvas id="game" width="960" height="540" aria-label="KettyBot Platformer"></canvas>

   <!-- === ØªØ­ÙƒÙ‘Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ === -->
<div class="touch" aria-hidden="true">
  <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ù…Ø´ÙŠ -->
  <div id="zone-left" class="panel" style="min-height:120px">
    <button class="tbtn circle" data-key="ArrowLeft">â—€</button>
    <button class="tbtn circle" data-key="ArrowRight">â–¶</button>
  </div>

  <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‚ÙØ²/Ø§Ù„Ø§Ù†Ø¯ÙØ§Ø¹ -->
  <div id="zone-right" class="panel" style="min-height:120px">
    <button class="tbtn big" data-key="Space">Ù‚ÙØ²</button>
    <button class="tbtn" data-key="KeyZ">Ø§Ù†Ø¯ÙØ§Ø¹</button>
  </div>
</div>


  <script>
  "use strict";

  // === ØªØ­ÙƒÙ… ÙŠØ¯ÙˆÙŠ 100% (Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø°ÙƒÙŠØ©) ===
  const PLAYER_WIDTH    = 14;   // Ø¹Ø±Ø¶ hitbox (Ù„Ù„ØªØµØ§Ø¯Ù…)
  const PLAYER_HEIGHT   = 36;   // Ø·ÙˆÙ„ hitbox
  const PLAYER_BASELINE = 0;    // Ù…Ø³Ø§ÙØ© Ø¨Ø³ÙŠØ·Ø© Ø£Ø³ÙÙ„ Ø§Ù„Ù‚Ø¯Ù… (0-4 Ù…Ù†Ø§Ø³Ø¨)

  const MANUAL = {
    idle: { scale: 3, offsetY: -7 },  // ÙˆØ§Ù‚Ù: Ù†Ø²Ù‘Ù„ØªÙ‡ 6px Ù„ÙŠØ¬Ù„Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø¥Ø­ÙƒØ§Ù…
    walk: { scale: 3, offsetY: 0 }   // Ù…Ø´ÙŠ: Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø±Ø¶ Ù„ÙƒÙ† Ø£Ù‚Ù„ Ù…Ù† idle
  };

  // ===== Ø¹Ù†Ø§ØµØ± Ø£Ø³Ø§Ø³ÙŠØ© =====
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const startBtn = document.getElementById('start');
  const resetBtn = document.getElementById('reset');
  const elCoinCount = document.getElementById('coin-count');
  const elCoinTotal = document.getElementById('coin-total');
  const elTime = document.getElementById('time');
  const elLives = document.getElementById('lives');

  // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© =====
  const TILE = 48;
  const GRAV = 2000;
  const MOVE_A = 2000;
  const MAX_VX = 340;
  const JUMP_VY = 760;
  const FRICTION_G = 0.82;

  let running = false, last=0, time=0, lives=3, gameOver=false, youWin=false;

  // ===== Ø®Ø±ÙŠØ·Ø© Ù…Ø³ØªÙˆÙ‰ =====
  // # Ø£Ø±Ø¶(#)ØŒ B Ø·ÙˆØ¨ØŒ ? ØµÙ†Ø¯ÙˆÙ‚ØŒ P Ø£Ù†Ø¨ÙˆØ¨ØŒ o Ø¹Ù…Ù„Ø©ØŒ G Ù‡Ø¯ÙØŒ S Ø³Ø¨Ø§ÙˆÙ†ØŒ E Ø¹Ø¯Ùˆ
  const levelText = [
    "................................................................",
    "................................................................",
    ".............................................###................",
    "...........................................###...###............",
    "................................................................",
    "...............###......................###.....................",
    ".......................o.......................................",
    "....o.............###.....E.....ooo.............###.............",
    ".........o......o..............................................",
    "############################..................##################",
    "...............................................................",
    "..........B B B........E.....G.?.................o..............",
    "............................###.................................",
    "S.....################.................##############...........",
    "################################################################",
  ];

  const world  = { W: levelText[0].length*TILE, H: levelText.length*TILE };
  const camera = { x:0, y:0, w:cvs.width, h:cvs.height };
  const solids = [], coins = [], enemies = [];
  let goal=null, player=null;

  // ===== Sprites (Idle + Walk) =====
  const DEFAULT_ASSETS = {
    idle: 'assets/character_idle.png',
    walk: 'assets/character_walk.png'
  };
  const SPRITES = {
    idle: new Image(),
    walk: new Image(),
    haveWalk: false,
    ready: false,
    frameW: 0, frameH: 0,
    walkFrames: 4
  };

  function loadSprites(){
    const bust='?v='+Date.now();
    SPRITES.idle.onload=()=>{
      SPRITES.ready=true;
      SPRITES.frameW = SPRITES.idle.naturalWidth  || SPRITES.idle.width;
      SPRITES.frameH = SPRITES.idle.naturalHeight || SPRITES.idle.height;
    };
    SPRITES.idle.onerror = ()=>console.warn('âš ï¸ idle not found:', DEFAULT_ASSETS.idle);
    SPRITES.idle.src = DEFAULT_ASSETS.idle + bust;

    SPRITES.walk.onload=()=>{
      const w = SPRITES.walk.naturalWidth || SPRITES.walk.width;
      const h = SPRITES.walk.naturalHeight|| SPRITES.walk.height;
      if(w>0 && h>0){ SPRITES.haveWalk=true; SPRITES.frameW=Math.floor(w/SPRITES.walkFrames); SPRITES.frameH=h; }
    };
    SPRITES.walk.onerror = ()=>console.warn('âš ï¸ walk not found:', DEFAULT_ASSETS.walk);
    SPRITES.walk.src = DEFAULT_ASSETS.walk + bust;
  }
  loadSprites();

  // ===== Ø§Ù„Ù„Ø§Ø¹Ø¨ =====
  class Player{
    constructor(x,y){ this.x=x; this.y=y; this.w=PLAYER_WIDTH; this.h=PLAYER_HEIGHT; this.vx=0; this.vy=0; this.onGround=false; this.facing=1; }
  }

  // ===== Ø§Ù„Ø¹Ø¯Ùˆ =====
 class Enemy{
  constructor(x,y){
    // Ø­Ø¬Ù… Ø£ØµØºØ± Ù…Ù† Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø£Ù† Ø§Ù„Ø·ÙÙ„ Ø£Ù†Ø­Ù
    this.x=x; this.y=y; this.w=34; this.h=42;
    this.vx = -70;  // Ø³Ø±Ø¹Ø© Ø¯ÙˆØ±ÙŠØ© Ø¨Ø·ÙŠØ¦Ø©
    this.vy = 0;
    this.alive = true; this.onGround=false;

    // Ù…Ù†Ø·Ù‚ Ù…Ø·Ø§Ø±Ø¯Ø©
    this.state = 'patrol';          // 'patrol' | 'chase'
    this.chaseSpeed = 145;          // Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø·Ø§Ø±Ø¯Ø©
    this.patrolSpeed = 70;
    this.detectRadius = 260;        // Ù†ØµÙ Ù‚Ø·Ø± Ø±Ø¤ÙŠØ© Ø§Ù„Ø·ÙÙ„
    this.flip = 1;                  // Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙˆØ¬Ù‡ (1 ÙŠÙ…ÙŠÙ†ØŒ -1 ÙŠØ³Ø§Ø±)
    this.t = 0;                     // Ø²Ù…Ù† Ù„Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
  }
}

  // ===== Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù„Ù… =====
  function resetWorld(){
    solids.length=0; coins.length=0; enemies.length=0;
    goal=null; player=null; time=0; gameOver=false; youWin=false;

    for(let r=0;r<levelText.length;r++){
      for(let c=0;c<levelText[r].length;c++){
        const ch=levelText[r][c], x=c*TILE, y=r*TILE;
        if(ch==='#') solids.push({x,y,w:TILE,h:TILE,type:'ground'});
        if(ch==='B') solids.push({x,y,w:TILE,h:TILE,type:'brick'});
        if(ch==='?') solids.push({x,y,w:TILE,h:TILE,type:'qblock'});
        if(ch==='P') solids.push({x:x, y:y-TILE, w:TILE, h:TILE*2, type:'pipe'});
        if(ch==='o') coins.push({x:x+TILE/2, y:y+TILE/2, r:14, t:Math.random()*6, taken:false});
        if(ch==='G') goal = {x:x+TILE/2, y:y+TILE-10};
        if(ch==='S') player = new Player(x+10, y-10);
        if(ch==='E') enemies.push(new Enemy(x+4, y-12));
      }
    }
    if(!player) player = new Player(24,24);

    // Ø±ÙØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¥Ù† Ø¨Ø¯Ø£ Ù…ØªØ¯Ø§Ø®Ù„
    let guard=0;
    while(collideAny({x:player.x,y:player.y,w:player.w,h:player.h}) && guard++<80){ player.y -= 2; }

    elCoinTotal.textContent = coins.length;
    elCoinCount.textContent = collectedCoins();
    elLives.textContent = lives;
  }

  function collectedCoins(){ return coins.filter(c=>c.taken).length; }

  // ===== Ø¥Ø¯Ø®Ø§Ù„ =====
  const keys = new Set(), keyLatch = new Set();
  addEventListener('keydown', e=>{ keys.add(e.code); });
  addEventListener('keyup',   e=>{ keys.delete(e.code); keyLatch.delete('jump'); });
 /* ===== ØªØ­ÙƒÙ‘Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù† (Pointer Events + Ø³Ø­Ø¨) ===== */
const press   = (code, el)=>{ keys.add(code); el?.classList.add('on'); if(navigator.vibrate) navigator.vibrate(10); };
const release = (code, el)=>{ keys.delete(code); if(code==='Space') keyLatch.delete('jump'); el?.classList.remove('on'); };

function bindButton(btn){
  const code = btn.dataset.key;
  btn.addEventListener('pointerdown', e=>{
    e.preventDefault(); btn.setPointerCapture(e.pointerId);
    press(code, btn);
  });
  const up = e=>{ try{ btn.releasePointerCapture(e.pointerId); }catch{} release(code, btn); };
  btn.addEventListener('pointerup', up);
  btn.addEventListener('pointercancel', up);
  btn.addEventListener('lostpointercapture', up);
}
document.querySelectorAll('.tbtn').forEach(bindButton);

/* Ù…Ù†Ø§Ø·Ù‚ Ø³Ø­Ø¨ Ø¹Ù…Ù„ÙŠÙ‘Ø©:
   - Ø§Ù„Ø³Ø­Ø¨ Ø£ÙÙ‚ÙŠØ§Ù‹ Ø¹Ù„Ù‰ ÙŠØ³Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© â‡’ ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø±
   - Ø¶ØºØ·Ø© Ù‚ØµÙŠØ±Ø© ÙÙŠ Ø§Ù„ÙŠÙ…ÙŠÙ† â‡’ Ù‚ÙØ²
   - Ù†Ù‚Ø±Ø© Ù…Ø²Ø¯ÙˆØ¬Ø© ÙÙŠ Ø§Ù„ÙŠÙ…ÙŠÙ† â‡’ Ø§Ù†Ø¯ÙØ§Ø¹ (KeyZ)
*/
const leftZone  = document.getElementById('zone-left');
const rightZone = document.getElementById('zone-right');

let swipe = { id:null, startX:0, active:'none' };
const SWIPE_DEAD = 16;   // Ø¹ØªØ¨Ø© Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ©
const SWIPE_MIN   = 40;  // Ù…Ø³Ø§ÙØ© Ù…ØªÙˆØ³Ø·Ø© Ù„Ø§Ø¹ØªØ¨Ø§Ø± Ø§ØªØ¬Ø§Ù‡ ÙˆØ§Ø¶Ø­

leftZone.addEventListener('pointerdown', e=>{
  e.preventDefault(); leftZone.setPointerCapture(e.pointerId);
  swipe.id = e.pointerId; swipe.startX = e.clientX; swipe.active = 'none';
});

leftZone.addEventListener('pointermove', e=>{
  if(swipe.id !== e.pointerId) return;
  const dx = e.clientX - swipe.startX;
  // Ø§Ø·ÙÙ ÙƒÙ„Ø§ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹
  keys.delete('ArrowLeft'); keys.delete('ArrowRight');
  if(Math.abs(dx) < SWIPE_DEAD){ swipe.active = 'none'; return; }
  if(dx > SWIPE_MIN){ keys.add('ArrowRight'); swipe.active = 'right'; }
  else if(dx < -SWIPE_MIN){ keys.add('ArrowLeft'); swipe.active = 'left'; }
});

function endSwipe(){
  keys.delete('ArrowLeft'); keys.delete('ArrowRight');
  swipe.id = null; swipe.active = 'none';
}
leftZone.addEventListener('pointerup',   endSwipe);
leftZone.addEventListener('pointercancel', endSwipe);
leftZone.addEventListener('lostpointercapture', endSwipe);

/* ÙŠÙ…ÙŠÙ†: Ù‚ÙØ²/Ø§Ù†Ø¯ÙØ§Ø¹ Ù…Ø¹ Ù†Ù‚Ø±Ø© Ù…Ø²Ø¯ÙˆØ¬Ø© */
let lastTap = 0;
rightZone.addEventListener('pointerdown', e=>{
  e.preventDefault(); rightZone.setPointerCapture(e.pointerId);
});
rightZone.addEventListener('pointerup', e=>{
  const now = performance.now();
  const dt = now - lastTap;
  lastTap = now;
  // Ù†Ù‚Ø±Ø© Ù…Ø²Ø¯ÙˆØ¬Ø© Ø®Ù„Ø§Ù„ 280ms â‡’ Ø§Ù†Ø¯ÙØ§Ø¹
  if(dt > 0 && dt < 280){
    press('KeyZ'); setTimeout(()=>release('KeyZ'), 160);
  }else{
    // Ù‚ÙØ² Ø¹Ø§Ø¯ÙŠ
    press('Space'); setTimeout(()=>release('Space'), 80);
  }
});
rightZone.addEventListener('pointercancel', ()=> release('Space'));
rightZone.addEventListener('lostpointercapture', ()=> release('Space'));

/* Ù…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø©/Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
['touchstart','touchmove','gesturestart'].forEach(ev=>{
  window.addEventListener(ev, e=>{
    if(e.target.closest('.touch') || e.target.id === 'game'){ e.preventDefault(); }
  }, { passive:false });
});


  // ===== ØªØµØ§Ø¯Ù… =====
  function rectOverlap(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }
  function collideAny(r){ for(const s of solids){ if(rectOverlap(r, s)) return true; } return false; }
 function collideSolids(px, py, pw, ph){
  const EPS = 0.001;
  const STEP = 8; // Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø·Ù„ÙˆØ¹ Ø¹Ù„ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ø¨ÙƒØ³Ù„)

  // Ù…Ø­ÙˆØ± X Ù…Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© step-up
  let rx = px, ry = py;
  for (const s of solids) {
    if (rx < s.x + s.w && rx + pw > s.x && ry < s.y + s.h && ry + ph > s.y) {
      const fromLeft  = (rx + pw) - s.x;       // Ø¯Ø®Ù„ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø±
      const fromRight = (s.x + s.w) - rx;      // Ø¯Ø®Ù„ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ†
      const preferLeft = fromLeft < fromRight;

      // Ø¬Ø±Ù‘Ø¨ÙŠ Ù†Ø±ÙØ¹Ù‡ Ù‚Ù„ÙŠÙ„ Ø¹Ø´Ø§Ù† ÙŠØ·Ù„Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ© Ø¨Ø¯Ù„ Ù…Ø§ ÙŠÙ„ØµÙ‚
      let tryY = ry - STEP;
      let canStep = true;
      for (const t of solids) {
        if (tryY < t.y + t.h && tryY + ph > t.y && rx < t.x + t.w && rx + pw > t.x) { canStep = false; break; }
      }
      if (canStep) {
        ry = tryY; // Ø§Ø±ÙØ¹Ù‡ ÙˆØ§Ù†ØªÙ‡ÙŠÙ†Ø§ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ØµØ¯Ø§Ù…
        continue;
      }

      // Ù…Ø§ Ù†ÙØ¹ØŸ Ø§Ø¨Ø¹Ø¯Ù‡ Ø£ÙÙ‚ÙŠØ§Ù‹
      if (preferLeft) rx -= fromLeft + EPS;
      else            rx += fromRight + EPS;
    }
  }

  // Ù…Ø­ÙˆØ± Y
  for (const s of solids) {
    if (rx < s.x + s.w && rx + pw > s.x && py < s.y + s.h && py + ph > s.y) {
      const fromTop    = (py + ph) - s.y;   // Ø³Ù‚Ø· ÙÙˆÙ‚ Ø§Ù„Ø³Ø·Ø­
      const fromBottom = (s.y + s.h) - py;  // Ø¶Ø±Ø¨ Ù…Ù† ØªØ­Øª
      if (fromTop < fromBottom) py -= fromTop + EPS;
      else                      py += fromBottom + EPS;
    }
  }

  return { x: rx, y: py };
}

  // ===== Ù…Ù†Ø·Ù‚ Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„Ø­ÙŠØ§Ø© =====
  function damagePlayer(){
    if(gameOver||youWin) return;
    lives--; elLives.textContent = Math.max(0,lives);
    if(lives<=0){ gameOver=true; running=false; showBanner('ğŸ’€ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª â€” Ø§Ø¶ØºØ·ÙŠ "Ø¥Ø¹Ø§Ø¯Ø©"'); }
    else { respawn(); }
  }

  // ===== ØªØ­Ø¯ÙŠØ« =====
  function update(dt){
    time += dt; elTime.textContent = time.toFixed(1);

    // Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ø§Ø¹Ø¨
    if(keys.has('ArrowLeft')||keys.has('KeyA')){ player.vx -= MOVE_A*dt; player.facing=-1; }
    if(keys.has('ArrowRight')||keys.has('KeyD')){ player.vx += MOVE_A*dt; player.facing= 1; }
    if(!(keys.has('ArrowLeft')||keys.has('KeyA')||keys.has('ArrowRight')||keys.has('KeyD')) && player.onGround){ player.vx *= FRICTION_G; }
    player.vx = Math.max(-MAX_VX, Math.min(MAX_VX, player.vx));

    const wantJump = keys.has('Space')||keys.has('KeyW')||keys.has('ArrowUp');
    if(wantJump && !keyLatch.has('jump')){ keyLatch.add('jump'); if(player.onGround){ player.vy = -JUMP_VY; player.onGround=false; } }
    if(!wantJump){ keyLatch.delete('jump'); }

    // ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨
    player.vy += GRAV*dt;
    let nx = player.x + player.vx*dt;
    let ny = player.y + player.vy*dt;

    let test = collideSolids(nx, player.y, player.w, player.h);
    if(test.x !== nx){ player.vx = 0; } player.x = test.x;

    test = collideSolids(player.x, ny, player.w, player.h);
    if(test.y !== ny){ if(player.vy>0) player.onGround=true; else player.onGround=false; player.vy=0; ny=test.y; }
    else { player.onGround=false; }
    player.y = ny;

    // Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª
    for(const c of coins){
      if(!c.taken){
        const dx=(player.x+player.w/2)-c.x, dy=(player.y+player.h/2)-c.y;
        if(Math.hypot(dx,dy)<26){ c.taken=true; elCoinCount.textContent = collectedCoins(); }
      }
      c.t += dt;
    }

    // Ø£Ø¹Ø¯Ø§Ø¡: Ø­Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø© + ÙÙŠØ²ÙŠØ§Ø¡ + Ø§Ø±ØªØ¯Ø§Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙˆØ§Ù/Ø§Ù„Ø¹ÙˆØ§Ø¦Ù‚
    // Ø£Ø¹Ø¯Ø§Ø¡: Ø¯ÙˆØ±ÙŠØ© + Ù…Ø·Ø§Ø±Ø¯Ø© + ÙÙŠØ²ÙŠØ§Ø¡ Ø¨Ø³ÙŠØ·Ø©
for(const e of enemies){
  if(!e.alive) continue;
  e.t += dt;

  // Ù‚Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ø·Ø§Ø±Ø¯Ø© Ø¥Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¯Ø§Ø®Ù„ Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± ÙˆØ¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ
  const dxp = (player.x + player.w/2) - (e.x + e.w/2);
  const dyp = Math.abs( (player.y + player.h/2) - (e.y + e.h/2) );
  const dist = Math.abs(dxp);

  if(dist < e.detectRadius && dyp < 100){
    e.state = 'chase';
    e.vx = (dxp > 0 ? e.chaseSpeed : -e.chaseSpeed);
  } else {
    // Ø¯ÙˆØ±ÙŠØ© Ø±Ø§ÙŠØ­Ø© Ø¬Ø§ÙŠØ©
    e.state = 'patrol';
    if(Math.abs(e.vx) < 1) e.vx = (Math.random()<0.5 ? -e.patrolSpeed : e.patrolSpeed);
    e.vx = (e.vx > 0 ? e.patrolSpeed : -e.patrolSpeed);
  }

  // Ø§ØªÙ‘Ø¬Ø§Ù‡ Ø§Ù„ÙˆØ¬Ù‡
  e.flip = e.vx >= 0 ? 1 : -1;

  // Ø¬Ø§Ø°Ø¨ÙŠØ©
  e.vy += GRAV*dt*0.9;

  // Ù…Ø­ÙˆØ± X Ù…Ø¹ Ø§Ø±ØªØ¯Ø§Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù…
  let ex = e.x + e.vx*dt;
  let ey = e.y + e.vy*dt;

  let t1 = collideSolids(ex, e.y, e.w, e.h);
  if(t1.x !== ex){
    // Ø§ØµØ·Ø¯Ù… Ø£ÙÙ‚ÙŠØ§Ù‹ â†’ Ø§Ø¹ÙƒØ³ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±ÙŠØ©ØŒ Ø£Ùˆ Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø§Ù„ØªÙØ§Ù ÙÙŠ Ø§Ù„Ù…Ø·Ø§Ø±Ø¯Ø©
    if(e.state==='patrol'){
      e.vx = -e.vx;
    }else{
      // ÙÙŠ Ø§Ù„Ù…Ø·Ø§Ø±Ø¯Ø©: Ù…Ø­Ø§ÙˆÙ„Ø© "step-up" ØµØºÙŠØ±Ø©
      const STEP = 8;
      let tryY = e.y - STEP, canStep = true;
      for(const s of solids){
        if(tryY < s.y+s.h && tryY+e.h > s.y && e.x < s.x+s.w && e.x+e.w > s.x){ canStep=false; break; }
      }
      if(canStep){ e.y = tryY; }
      else { e.vx = -e.vx*0.5; } // Ø§Ù„ØªÙØ§Ù Ø®ÙÙŠÙ
    }
  } else {
    e.x = ex;
  }

  // ØªØ­Ù‚Ù‚ Ø­Ø§ÙØ© Ø£Ù…Ø§Ù… Ø§Ù„Ù‚Ø¯Ù…ÙŠÙ† (ÙÙŠ Ø§Ù„Ø¯ÙˆØ±ÙŠØ© Ø¨Ø³)ØŒ ÙˆØ¥Ù„Ø§ Ø§Ù†Ø¹ÙƒØ³
  if(e.state==='patrol'){
    const aheadX = e.x + (e.vx>0 ? e.w+2 : -2);
    const footY  = e.y + e.h + 4;
    const groundAhead = solids.some(s => aheadX>=s.x && aheadX<=s.x+s.w && footY>=s.y && footY<=s.y+s.h);
    if(!groundAhead){ e.vx = -e.vx; }
  }

  // Ù…Ø­ÙˆØ± Y
  let t2 = collideSolids(e.x, ey, e.w, e.h);
  if(t2.y !== ey){ if(e.vy>0) e.onGround=true; else e.onGround=false; e.vy=0; ey=t2.y; } else e.onGround=false;
  e.y = ey;

  // Ø§ØµØ·Ø¯Ø§Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø¹ Ø§Ù„Ø¹Ø¯Ùˆ (Ø¯Ø¹Ø³ Ø£Ùˆ Ø¥Ù…Ø³Ø§Ùƒ)
  if(rectOverlap({x:player.x,y:player.y,w:player.w,h:player.h}, {x:e.x,y:e.y,w:e.w,h:e.h})){
    const playerBottom = player.y + player.h;
    const enemyTop = e.y;
    if(player.vy > 200 && playerBottom - enemyTop < 28){ // Ø¯Ø¹Ø³ Ù…Ù† ÙÙˆÙ‚
      e.alive=false;
      player.vy = -620; // Ø§Ø±ØªØ¯Ø§Ø¯
    }else{
      damagePlayer(); // Ø§Ù„Ø·ÙÙ„ "ÙŠÙ…Ø³Ùƒ" Ø§Ù„Ù„Ø§Ø¹Ø¨
      break;
    }
  }
}


    // Ø³Ù‚ÙˆØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¹Ø§Ù„Ù…
    if(player.y > world.H + 300){ damagePlayer(); }

    // Ø§Ù„Ù‡Ø¯Ù â€” Ø§Ù„ÙÙˆØ² Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø· Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª (Ù…ÙƒØ§ÙØ£Ø© ÙÙ‚Ø·)
    if(goal && rectOverlap({x:player.x,y:player.y,w:player.w,h:player.h},{x:goal.x-16,y:goal.y-36,w:32,h:36})){
      youWin = true; running=false;
      const bonus = (collectedCoins()===coins.length && coins.length>0) ? " + Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª! ğŸŸ¡" : "";
      showBanner('ğŸ‰ ÙÙˆØ²!'+bonus+' â€” Ø§Ø¶ØºØ·ÙŠ "Ø¥Ø¹Ø§Ø¯Ø©" Ù„Ù„Ø¹Ø¨ Ù…Ø¬Ø¯Ø¯Ù‹Ø§');
showBanner("", true); // â† Ù‡Ø°Ø§ ÙŠÙØ¹Ù‘Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø®Ø§Øµ

    }

    // ÙƒØ§Ù…ÙŠØ±Ø§
    camera.x = Math.max(0, Math.min(world.W - camera.w, player.x + player.w/2 - camera.w/2));
    camera.y = Math.max(0, Math.min(world.H - camera.h, player.y + player.h/2 - camera.h/2));
  }

  // ===== Ø±Ø³Ù… =====
  function draw(){
drawBackgroundWithShopsOnly();   // Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©
  ctx.imageSmoothingEnabled = false;

  // Ù…Ù† Ù‡Ù†Ø§ ÙŠØ¨Ø¯Ø£ Ø¹Ø§Ù„Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…ØªØ­Ø±Ùƒ
  ctx.translate(-camera.x, -camera.y);

    for(const s of solids) drawSolid(s);
    for(const c of coins) if(!c.taken) drawCoin(c);
    if(goal) drawGoal(goal);
    for(const e of enemies) if(e.alive) drawEnemy(e);

    drawKetty(player.x, player.y);
  }

  // ===== Ø®Ù„ÙÙŠØ© Ù…Ø§Ø±ÙŠÙˆ =====
  function drawBackgroundWithShopsOnly(){
  // Ø³Ù…Ø§Ø¡ ÙˆØ³Ø­Ø¨ Ù†Ø§Ø¹Ù…Ø© ÙÙ‚Ø· (Ø§Ù„Ø³Ø­Ø¨ ØªØªØ­Ø±Ùƒ Ù‚Ù„ÙŠÙ„Ø§Ù‹ØŒ Ø§Ù„Ù…Ø­Ù„Ø§Øª/Ø§Ù„Ø£Ø´Ø¬Ø§Ø±/Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø«Ø§Ø¨ØªØ©)
  ctx.setTransform(1,0,0,1,0,0);
  const g = ctx.createLinearGradient(0,0,0,cvs.height);
  g.addColorStop(0, getCss('--sky1') || '#7cc7ff');
  g.addColorStop(1, getCss('--sky2') || '#cfeeff');
  ctx.fillStyle = g; 
  ctx.fillRect(0,0,cvs.width,cvs.height);

  // Ø³Ø­Ø¨ Ø®ÙÙŠÙØ© (Ø­Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø© Ù„Ø§ ØªØ²Ø¹Ø¬)
  ctx.imageSmoothingEnabled = false;
  ctx.globalAlpha = .9; ctx.fillStyle = '#ffffff';
  for(let i=0;i<6;i++){
    const x = (i*200 - (camera.x*0.20)%260) + 60;
    const y = 70 + (i%3)*22;
    ctx.beginPath(); ctx.ellipse(x, y, 38, 18, 0, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x+28, y+4, 24, 12, 0, 0, Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha = 1;

  // baseline Ø«Ø§Ø¨Øª Ù„Ù„Ù…Ø­Ù„Ø§Øª ÙˆØ§Ù„Ø±ØµÙŠÙ
  const SHOPS_Y = Math.floor(cvs.height*0.70);

  // Ù…Ø­Ù„Ø§Øª Ø«Ø§Ø¨ØªØ© (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ­Ø±ÙŠÙƒ)
  drawShopsRow(0, SHOPS_Y, cvs.width);

  // Ø±ØµÙŠÙ Ø£Ø¹Ø±Ø¶ Ø£Ù…Ø§Ù… Ø§Ù„Ù…Ø­Ù„Ø§Øª (Ø¹Ø±Ø¶ Ø£ÙƒØ¨Ø±)
  drawPavementRow(0, SHOPS_Y, cvs.width, 140); // â† Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø±ØµÙŠÙ 40px

  // Ø£Ø´Ø¬Ø§Ø± ÙˆØ£Ø¹Ù…Ø¯Ø© Ø¥Ù†Ø§Ø±Ø© Ø«Ø§Ø¨ØªØ©
  drawStreetDetails(0, SHOPS_Y + 40, cvs.width); // Ø§Ø±Ø³Ù…Ù‡Ø§ Ø¹Ù„Ù‰ Ø­Ø§ÙØ© Ø§Ù„Ø±ØµÙŠÙ
}


function drawSkyline(startX, baselineY, avgH, jitter, col1, col2){
  // Ù†Ø¨Ù†ÙŠ Ù…Ø¨Ø§Ù†Ù Ù…Ø³ØªØ·ÙŠÙ„Ø© Ù…Ø®ØªÙ„ÙØ© Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹ØŒ Ù…Ø¹ Ù†ÙˆØ§ÙØ° Ù†Ù‚Ø§Ø·
  const W = cvs.width*2;          // Ø¨Ø¹Ø±Ø¶ Ù…Ø¶Ø§Ø¹Ù ÙƒÙŠ ÙŠØªÙƒØ±Ø± Ø¨Ø§Ù†Ø³ÙŠØ§Ø¨
  let x = startX - ( (camera.x|0) % 240 ); // Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
  while(x < startX + W){
    const w = 80 + ((x*37)%70);                 // Ø¹Ø±Ø¶ Ù…ØªØºÙŠÙ‘Ø±
    const h = avgH + ((x*53)%jitter) - jitter/2;// Ø§Ø±ØªÙØ§Ø¹ Ù…ØªØºÙŠÙ‘Ø±
    const y = baselineY - h;

    // Ø¬Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø¨ØªØ¯Ø±Ù‘Ø¬ Ø·ÙˆÙ„ÙŠ Ø®ÙÙŠÙ
    const g = ctx.createLinearGradient(0,y,0,y+h);
    g.addColorStop(0,col1); g.addColorStop(1,col2);
    ctx.fillStyle = g;
    ctx.fillRect(x, y, w, h);

    // Ù†ÙˆØ§ÙØ° Ù†Ù‚Ø·ÙŠØ©
    ctx.globalAlpha = .25; ctx.fillStyle = '#fff';
    for(let yy=y+10; yy<y+h-10; yy+=14){
      for(let xx=x+10; xx<x+w-10; xx+=18){
        if(((xx+yy)>>3)&1) ctx.fillRect(xx, yy, 3, 3);
      }
    }
    ctx.globalAlpha = 1;

    // Ø£Ø³Ø·Ø­ Ø¨Ø³ÙŠØ·Ø©
    ctx.fillStyle = 'rgba(0,0,0,.18)';
    ctx.fillRect(x, y, w, 3);

    x += w + 24;
  }
}

// ÙŠØ±Ø³Ù… ØµÙÙ‹Ø§ Ù…ØªÙƒØ±Ø±Ù‹Ø§ Ù…Ù† Ù…Ø­Ù„Ø§Øª (Ù…Ø·Ø¹Ù…/Ù…Ù‚Ù‡Ù‰/Ù…Ø§Ø±ÙƒØª)
function drawShopsRow(startX, baselineY, spanW){
  let x = startX;                  // Ø¨Ø¯ÙˆÙ† camera.x
  while(x < startX + spanW){
    drawShop(x+10, baselineY-78, 120, 78, 0); // typeIndex Ù…Ù‡Ù…Ù„
    x += 160;
  }
}


function drawShop(x, y, w, h, _typeIndex){
  // Ø¬Ø¯Ø§Ø± + Ø³Ù‚Ù
  ctx.fillStyle = getCss('--shopWall');
  ctx.fillRect(x, y, w, h);

  ctx.fillStyle = getCss('--shopRoof');
  ctx.fillRect(x-6, y-10, w+12, 10);      // Ø³Ù‚Ù Ø¹Ù„ÙˆÙŠ
  ctx.fillRect(x, y, w, 4);               // ÙƒØ±Ø§Ù†ÙŠØ´ ØµØºÙŠØ±Ø©

  // Ø¨Ø§Ø¨ ÙˆØ²Ø¬Ø§Ø¬
  ctx.fillStyle = getCss('--shopDoor');
  ctx.fillRect(x+10, y+h-40, 24, 40);     // Ø¨Ø§Ø¨
  ctx.fillStyle = getCss('--shopGlass');
  ctx.fillRect(x+40, y+16, w-52, h-46);   // ÙˆØ§Ø¬Ù‡Ø© Ø²Ø¬Ø§Ø¬

  // Ù…Ø¸Ù„Ø© Ù…Ø®Ø·Ø·Ø© (Ø¨Ø¯ÙˆÙ† Ù†Øµ)
  const stripeW = 10;
  for(let i=0;i<w;i+=stripeW){
    ctx.fillStyle = ( (i/stripeW)&1 ) ? getCss('--awning1') : getCss('--awning2');
    ctx.fillRect(x+i, y+6, stripeW, 10);
  }

  // Ø´Ø±ÙŠØ· Ø¥Ø¶Ø§Ø¡Ø© Ù…Ù„ÙˆÙ‘Ù† Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø§Øª (Accent)
  ctx.fillStyle = getCss('--accent');
  roundRect(x+w-76, y-20, 72, 14, 6, true, false);
  ctx.globalAlpha = .35;
  ctx.fillRect(x+w-76, y-8, 72, 2); // ØªÙˆÙ‡Ø¬ Ø¨Ø³ÙŠØ· ØªØ­Øª Ø§Ù„Ø´Ø±ÙŠØ·
  ctx.globalAlpha = 1;
}
function drawPavementRow(startX, baselineY, spanW, h=1){
  const tileW = 100;

  // Ø¬Ø³Ù… Ø§Ù„Ø±ØµÙŠÙ
  ctx.fillStyle = getCss('--pavement') || '#d9d9d9';
  ctx.fillRect(startX, baselineY, spanW, h);

  // Ø­Ø§ÙØ© Ø¹Ù„ÙˆÙŠØ© Ø¯Ø§ÙƒÙ†Ø© (ÙŠÙØµÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø¹Ù† Ø§Ù„Ø±ØµÙŠÙ)
  ctx.fillStyle = getCss('--pavementDark') || '#bfbfbf';
  ctx.fillRect(startX, baselineY, spanW, 3);

  // ØªØ´Ù‚ÙŠÙ‚ Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª (Ø®Ø·ÙˆØ· Ø±Ø£Ø³ÙŠØ© ÙƒÙ„ tileW)
  ctx.strokeStyle = getCss('--pavementDark') || '#bfbfbf';
  ctx.lineWidth = 2;
  for(let x = startX + tileW; x < startX + spanW; x += tileW){
    ctx.beginPath();
    ctx.moveTo(x, baselineY+4);
    ctx.lineTo(x, baselineY+h-2);
    ctx.stroke();
  }

  // Ø¸Ù„ Ø®ÙÙŠÙ Ø£Ø³ÙÙ„ Ø§Ù„Ø±ØµÙŠÙ
  ctx.globalAlpha = .10; ctx.fillStyle = '#000';
  ctx.fillRect(startX, baselineY+h-2, spanW, 2);
  ctx.globalAlpha = 1;
}



function roundedBand(x, y, w, h, bg, fg, text){
  // Ø´Ø±ÙŠØ· Ù…Ø³ØªØ¯ÙŠØ± Ù…Ø¹ Ù†Øµ
  ctx.fillStyle = bg; roundRect(x, y, w, h, 6, true, false);
  ctx.fillStyle = fg; ctx.fillText(text, x+8, y+2);
  // ØªÙˆÙ‡Ø¬ Ø¨Ø³ÙŠØ·
  ctx.globalAlpha=.35; ctx.fillStyle = fg;
  ctx.fillRect(x, y+h-2, w, 2);
  ctx.globalAlpha=1;
}

function drawStreetDetails(startX, baselineY, spanW){
  for(let x = startX; x < startX + spanW; x += 240){
    // Ø´Ø¬Ø±Ø©
    ctx.fillStyle = getCss('--treeDark'); ctx.fillRect(x+30, baselineY-20, 10, 24);
    ctx.fillStyle = getCss('--tree');
    ctx.beginPath(); ctx.arc(x+35, baselineY-26, 14, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+44, baselineY-18, 12, 0, Math.PI*2); ctx.fill();

    // Ø¹Ù…ÙˆØ¯ Ø¥Ù†Ø§Ø±Ø©
    ctx.fillStyle = '#4b5563';
    ctx.fillRect(x+140, baselineY-42, 4, 42);
    ctx.fillStyle = '#ffd966';
    ctx.beginPath(); ctx.arc(x+142, baselineY-46, 6, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha=.15; ctx.beginPath(); ctx.arc(x+142, baselineY-46, 24, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
  }
}


  // ===== Ø±Ø³Ù… Ø¨Ù„Ø§Ø·Ø§Øª =====
  function drawSolid(s){
    if(s.type==='pipe'){
      const lip = 12;
      ctx.fillStyle = getCss('--pipe');
      ctx.fillRect(s.x, s.y+lip, s.w, s.h-lip);
      ctx.fillStyle = getCss('--pipeDark');
      ctx.fillRect(s.x + s.w*0.65, s.y+lip+2, 4, s.h-lip-4);
      ctx.fillStyle = getCss('--pipe');
      ctx.fillRect(s.x-6, s.y, s.w+12, lip);
      ctx.strokeStyle = '#0d5c26'; ctx.lineWidth = 2;
      ctx.strokeRect(s.x-6+.5, s.y+.5, s.w+12-1, lip-1);
      return;
    }
    if(s.type==='qblock'){
      const x=s.x+2, y=s.y+2, w=s.w-4, h=s.h-4;
      ctx.fillStyle = '#f6a91a'; ctx.fillRect(x,y,w,h);
      ctx.fillStyle = '#ffd37a'; ctx.fillRect(x,y, w, 6);
      ctx.strokeStyle = '#b06a12'; ctx.lineWidth = 2; ctx.strokeRect(x+.5,y+.5,w-1,h-1);
      ctx.fillStyle = '#6b3a0b'; ctx.font='bold 24px system-ui'; ctx.fillText('?', x+w/2-7, y+h/2+8);
      return;
    }
    if(s.type==='brick'){
      const x=s.x+2, y=s.y+2, w=s.w-4, h=s.h-4;
      ctx.fillStyle = getCss('--brick'); ctx.fillRect(x,y,w,h);
      ctx.fillStyle = getCss('--brick2'); ctx.fillRect(x, y+h/2-2, w, 4); ctx.fillRect(x+w/2-2, y, 4, h);
      ctx.strokeStyle = '#6d2b0e'; ctx.lineWidth=1; ctx.strokeRect(x+.5,y+.5,w-1,h-1);
      return;
    }
    // Ø£Ø±Ø¶
    const x=s.x, y=s.y, w=s.w, h=s.h;
    ctx.fillStyle = getCss('--soil');  ctx.fillRect(x,y,w,h);
    ctx.fillStyle = getCss('--soil2');
    for(let iy=0; iy<h; iy+=12) for(let ix=0; ix<w; ix+=12) ctx.fillRect(x+ix, y+iy, 10, 10);
    ctx.fillStyle = getCss('--grass');  ctx.fillRect(x, y, w, 10);
    ctx.fillStyle = getCss('--grass2'); ctx.fillRect(x, y, w, 4);
  }

  // ===== Ø¹Ù…Ù„Ø© =====
  function drawCoin(c){
  // === Ø¨Ø·Ø§Ø±ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¹Ù…Ù„Ø© ===
  // ØªÙ‡ØªØ²Ù‘ Ø®ÙÙŠÙ ÙˆØªØ·ÙÙˆ Ù„Ù„Ø£Ø¹Ù„Ù‰/Ø§Ù„Ø£Ø³ÙÙ„ Ù…Ø«Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª
  const t = c.t * 6;
  const bob = Math.sin(t) * 3;         // Ø·ÙÙˆ
  const charge = (Math.sin(t*0.6)+1)/2; // Ù†Ø³Ø¨Ø© Ø´Ø­Ù† 0..1 Ù…ØªØ­Ø±ÙƒØ©

  const W = 24;   // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
  const H = 36;   // Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
  const x = c.x - W/2;
  const y = c.y - H/2 - Math.sin(c.t*2)*6; // Ù†ÙØ³ Ø§Ù„Ø·ÙÙˆ Ø§Ù„Ù‚Ø¯ÙŠÙ…

  // Ø£Ù„ÙˆØ§Ù† (Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ)
  const caseCol   = '#2b2b2b';       // Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
  const capCol    = '#777';          // Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ø¹Ø¯Ù†ÙŠ
  const fillColHi = '#22c55e';       // Ø§Ù…ØªÙ„Ø§Ø¡ Ø£Ø®Ø¶Ø±
  const fillColLo = '#ef4444';       // Ù„Ùˆ Ø£Ø±Ø¯Øª ÙˆÙ…ÙŠØ¶ Ø£Ø­Ù…Ø± Ø¹Ù†Ø¯ Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø´Ø­Ù†
  const glassCol  = 'rgba(255,255,255,.25)';

  // Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù…ØªÙ„Ø§Ø¡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© (Ø±Ø¨Ø¹ Ø¥Ù„Ù‰ ÙƒØ§Ù…Ù„)
  const level = 0.25 + charge * 0.75;

  ctx.save();
  ctx.translate(0, bob*0.2); // Ø§Ù‡ØªØ²Ø§Ø² Ø¨Ø³ÙŠØ·

  // Ø¸Ù„ ØªØ­Øª Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
  ctx.globalAlpha = 0.25; ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.ellipse(c.x, c.y + H/2 + 8, 12, 4, 0, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha = 1;

  // Ø¬Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
  const r = 6; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø²ÙˆØ§ÙŠØ§
  ctx.fillStyle = caseCol;
  roundRect(x, y, W, H, r, true, false);

  // Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
  ctx.fillStyle = capCol;
  ctx.fillRect(x + W*0.3, y - 4, W*0.4, 6);

  // Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø´Ø­Ù†
  const pad = 4;
  const innerW = W - pad*2;
  const innerH = H - pad*2;
  const fillH = Math.max(2, Math.floor(innerH * level));
  ctx.fillStyle = level > 0.35 ? fillColHi : fillColLo;
  ctx.fillRect(x + pad, y + pad + (innerH - fillH), innerW, fillH);

  // ØªÙ‚Ø³ÙŠÙ…Ø§Øª â€œØ®Ù„Ø§ÙŠØ§â€ Ù„Ø·ÙŠÙØ©
  ctx.globalAlpha = .25;
  ctx.fillStyle = '#000';
  for(let yy = 0; yy < innerH; yy += 6){
    ctx.fillRect(x + pad, y + pad + yy, innerW, 1);
  }
  ctx.globalAlpha = 1;

  // Ù„Ù…Ø¹Ø§Ù† Ø²Ø¬Ø§Ø¬ÙŠ
  ctx.fillStyle = glassCol;
  roundRect(x+2, y+2, 6, H-4, 4, true, false);

  ctx.restore();
}


  // ===== Ø§Ù„Ø¹Ø¯Ùˆ Ø±Ø³Ù… =====
  function drawEnemy(e){
  ctx.save();

  // Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø³Ù…
  const x = e.x, y = e.y, w = e.w, h = e.h;

  // Ø§ØªÙ‘Ø¬Ø§Ù‡ Ø§Ù„ÙˆØ¬Ù‡
  if(e.flip === -1){
    ctx.translate(x + w/2, y + h/2);
    ctx.scale(-1, 1);
    ctx.translate(-(x + w/2), -(y + h/2));
  }

  // Ù…Ø¹Ø§Ù…Ù„ Ø­Ø±ÙƒØ© Ù„Ù„Ø£Ø°Ø±Ø¹/Ø§Ù„Ø£Ø±Ø¬Ù„
  const run = Math.min(1, Math.abs(e.vx)/e.chaseSpeed);
  const t = e.t * (6 + 4*run);
  const armSwing = Math.sin(t) * (8 + 6*run);  // ØªØ£Ø±Ø¬Ø­ Ø§Ù„Ø°Ø±Ø§Ø¹
  const legSwing = Math.sin(t + Math.PI/2) * (6 + 4*run);

  // Ø¸Ù„ ØªØ­Øª Ø§Ù„Ø·ÙÙ„
  ctx.globalAlpha = 0.22; ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.ellipse(x + w/2, y + h, Math.max(10, w*0.4), 5, 0, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha = 1;

  // Ø§Ù„Ø¬Ø³Ù… (Ù‚Ù…ÙŠØµ + Ø¨Ù†Ø·Ø§Ù„)
  ctx.fillStyle = getCss('--kid-shirt') || '#4f46e5';
  ctx.fillRect(x + w*0.25, y + h*0.30, w*0.5, h*0.42);
  ctx.fillStyle = getCss('--kid-pants') || '#374151';
  ctx.fillRect(x + w*0.28, y + h*0.68, w*0.44, h*0.18);

  // Ø±Ø£Ø³
  ctx.fillStyle = getCss('--kid-skin') || '#f6c39b';
  ctx.beginPath(); ctx.ellipse(x + w*0.5, y + h*0.18, w*0.26, h*0.18, 0, 0, Math.PI*2); ctx.fill();

  // Ø´Ø¹Ø±
  ctx.fillStyle = getCss('--kid-hair') || '#2b2b2b';
  ctx.beginPath();
  ctx.ellipse(x + w*0.5, y + h*0.12, w*0.28, h*0.10, 0, 0, Math.PI*2);
  ctx.fill();
  // Ø¹ÙŠÙ† ÙˆÙÙ… Ø¨Ø³ÙŠØ·
  ctx.fillStyle = '#111';
  ctx.fillRect(x + w*0.58, y + h*0.17, 2, 2); // Ø¹ÙŠÙ† ÙŠÙ…ÙŠÙ† (ÙŠØªØ¬Ù‡ ÙŠÙ…ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§)
  ctx.globalAlpha = .8; ctx.fillRect(x + w*0.48, y + h*0.24, 6, 1); ctx.globalAlpha = 1;

  // Ø°Ø±Ø§Ø¹Ø§Ù†: Ø§Ù„ÙŠÙ…Ù†Ù‰ ØªÙ…ØªØ¯ Ù„Ù„Ø£Ù…Ø§Ù… Ù„Ù„Ø¥Ù…Ø³Ø§Ùƒ
  ctx.fillStyle = getCss('--kid-skin') || '#f6c39b';
  // Ø°Ø±Ø§Ø¹ Ø£Ù…Ø§Ù…ÙŠØ© (ØªÙ…ØªØ¯)
  ctx.save();
  ctx.translate(x + w*0.7, y + h*0.40);
  ctx.rotate((-12 + armSwing*0.06) * Math.PI/180);
  ctx.fillRect(-2, 0, 16, 5);
  ctx.restore();

  // Ø°Ø±Ø§Ø¹ Ø®Ù„ÙÙŠØ©
  ctx.save();
  ctx.translate(x + w*0.30, y + h*0.40);
  ctx.rotate((12 - armSwing*0.06) * Math.PI/180);
  ctx.fillRect(-14, 0, 16, 5);
  ctx.restore();

  // Ø£Ø±Ø¬Ù„
  ctx.fillStyle = getCss('--kid-pants') || '#374151';
  // Ø±Ø¬Ù„ Ø£Ù…Ø§Ù…ÙŠØ©
  ctx.save();
  ctx.translate(x + w*0.58, y + h*0.78);
  ctx.rotate((-10 + legSwing*0.08) * Math.PI/180);
  ctx.fillRect(-2, 0, 12, 6);
  ctx.restore();
  // Ø±Ø¬Ù„ Ø®Ù„ÙÙŠØ©
  ctx.save();
  ctx.translate(x + w*0.42, y + h*0.78);
  ctx.rotate((10 - legSwing*0.08) * Math.PI/180);
  ctx.fillRect(-10, 0, 12, 6);
  ctx.restore();

  // Ø£Ø­Ø°ÙŠØ©
  ctx.fillStyle = getCss('--kid-shoes') || '#111827';
  ctx.fillRect(x + w*0.38, y + h*0.88, 10, 4);
  ctx.fillRect(x + w*0.56, y + h*0.88, 10, 4);

  ctx.restore();
}


  // ===== Ø§Ù„Ø¹Ù„Ù… =====
  function drawGoal(gp){
    ctx.save(); ctx.translate(gp.x, gp.y);
    ctx.fillStyle = '#2e7d32'; ctx.fillRect(-2,-40,4,40);
    ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(0,-40,3,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = getCss('--flag');
    ctx.beginPath(); ctx.moveTo(2,-36); ctx.lineTo(26,-30); ctx.lineTo(2,-24); ctx.closePath(); ctx.fill();
    ctx.restore();
  }

  // ===== Ø±Ø³Ù… Ø´Ø®ØµÙŠØ© KettyBot (ØªØ­ÙƒÙ… ÙŠØ¯ÙˆÙŠ Ø¨Ø§Ù„Ù€scale ÙˆØ§Ù„Ù€offsetY) =====
  function drawKetty(px, py){
    const w = player.w, h = player.h;
    const isWalking = (SPRITES.haveWalk && Math.abs(player.vx) > 10 && player.onGround);
    const cfg = isWalking ? MANUAL.walk : MANUAL.idle;
    let img = isWalking ? SPRITES.walk : SPRITES.idle;

    // Ù…ØµØ¯Ø± Ø§Ù„Ø¥Ø·Ø§Ø±
    let sx=0, sw, sh;
    if(isWalking){
      const frames = Math.max(1, SPRITES.walkFrames|0);
      sw = Math.floor((img.naturalWidth||img.width)/frames);
      sh = (img.naturalHeight||img.height);
      const fps=10, frame = Math.floor(time*fps)%frames;
      sx = frame*sw;
    }else{
      sw = SPRITES.frameW || (img.naturalWidth||img.width||w);
      sh = SPRITES.frameH || (img.naturalHeight||img.height||h);
    }

    // ØªØ­Ø¬ÙŠÙ… Ø¯Ø§Ø®Ù„ hitbox + Ù…Ù‚ÙŠØ§Ø³ ÙŠØ¯ÙˆÙŠ
    const fit = Math.min(w/sw, h/sh);
    const s   = fit * (cfg.scale || 1);
    const dw  = Math.max(1, Math.round(sw * s));
    const dh  = Math.max(1, Math.round(sh * s));

    const footY = py + h - PLAYER_BASELINE;
    const dy = Math.round( footY - dh - (cfg.offsetY || 0) );
    const dx = Math.round( px + (w - dw)/2 );

    ctx.save();
    ctx.imageSmoothingEnabled = false;
    if (player.facing === -1){
      ctx.translate(dx + dw/2, dy + dh/2);
      ctx.scale(-1, 1);
      ctx.translate(-(dx + dw/2), -(dy + dh/2));
    }

    if (img && (img.complete || img.naturalWidth)){
      ctx.drawImage(img, sx, 0, sw, sh, dx, dy, dw, dh);
    } else {
      ctx.fillStyle = '#f6c700'; ctx.fillRect(dx, dy, dw, dh);
      ctx.fillStyle = '#222';     ctx.fillRect(dx+6, dy+Math.round(dh*0.35), dw-12, Math.round(dh*0.55));
    }

    // Ø¸Ù„
    ctx.globalAlpha = 0.25; ctx.fillStyle = '#000';
    ctx.beginPath(); ctx.ellipse(px + w/2, py + h, Math.max(12, dw*0.35), 6, 0, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
    ctx.restore();
  }

  // ===== Ø£Ø¯ÙˆØ§Øª =====
  function roundRect(x,y,w,h,r,fill,stroke){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y); ctx.lineTo(x+w-rr, y);
    ctx.arcTo(x+w, y, x+w, y+rr, rr);
    ctx.lineTo(x+w, y+h-rr);
    ctx.arcTo(x+w, y+h, x+w-rr, y+h, rr);
    ctx.lineTo(x+rr, y+h);
    ctx.arcTo(x, y+h, x, y+h-rr, rr);
    ctx.lineTo(x, y+rr);
    ctx.arcTo(x, y, x+rr, y, rr);
    if(fill) ctx.fill();
    if(stroke) ctx.stroke();
  }
  function getCss(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function respawn(){
    for(let r=0;r<levelText.length;r++){
      for(let c=0;c<levelText[r].length;c++){
        if(levelText[r][c]==='S'){ player.x=c*TILE+10; player.y=r*TILE-10; player.vx=0; player.vy=0; return; }
      }
    }
    player.x=24; player.y=24; player.vx=player.vy=0;
  }
 function showBanner(msg, isAd=false){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.font='700 20px system-ui';

  if(isAd){
    // Ø¥Ø¹Ù„Ø§Ù† Ù…Ø®ØµØµ
    const text = "Ø§Ø´ØªØ±ÙƒÙˆØ§ Ø¨Ù€ QTP";
    const w = ctx.measureText(text).width+40;

    // Ø®Ù„ÙÙŠØ© Ø²Ø±Ù‚Ø§Ø¡ ØºØ§Ù…Ù‚Ø©
    ctx.fillStyle='#0a2540';
    ctx.fillRect(cvs.width/2-w/2, cvs.height/2-40, w, 80);

    // Ù†Øµ Ø£Ø¨ÙŠØ¶
    ctx.fillStyle='#fff';
    ctx.fillText(text, cvs.width/2-w/2+20, cvs.height/2+10);

    return;
  }

  // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ø®Ø³Ø§Ø±Ø©/Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…)
  const w = ctx.measureText(msg).width+28;
  ctx.fillStyle='rgba(0,0,0,.55)';
  ctx.fillRect(cvs.width/2-w/2, 20, w, 36);
  ctx.fillStyle='#e2e8f0';
  ctx.fillText(msg, cvs.width/2-w/2+14, 44);
}


  // ===== Ù„ÙˆØ¨ =====
  function loop(ts){
    if(!running){ draw(); return; }
    const dt = Math.min(0.033, (ts - last)/1000 || 0);
    last = ts; update(dt); draw(); requestAnimationFrame(loop);
  }

  // ===== ØªØ´ØºÙŠÙ„ =====
  resetWorld();
  draw();

  startBtn.addEventListener('click', ()=>{
    if(!running && !youWin && !gameOver){ running=true; last=performance.now(); requestAnimationFrame(loop); }
  });
  resetBtn.addEventListener('click', ()=>{
    running=false; resetWorld(); draw();
  });
  </script>
</body>
</html>



